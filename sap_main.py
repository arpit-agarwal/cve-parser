from sap.utils import get_security_alerts_json, get_publish_date, should_parse_bulletin
from common.html_parser import HTMLParser
from datetime import datetime

form_date_string = "January 2017"
to_date_string = "May 2020"
vendor = "sap"
url = "https://wiki.scn.sap.com/wiki/display/PSR/The+Official+SAP+Product+Security+Response+Space"

parser = HTMLParser(url)
outer_div = parser.get_tag_by_class("content-wrapper")
uls = outer_div.find_all("ul")

from_date = get_publish_date(form_date_string)
to_date = get_publish_date(to_date_string)

urls = list()
for ul in uls:
    for a in ul.find_all("a"):
        a_text = a.text.strip()
        if a_text is not None and a_text != "":
            date_string = a_text.rsplit("-",1)[1].strip()
            if should_parse_bulletin(date_string,from_date, to_date):
                href = a.get("href")
                urls.append(href)

div_class = "table-wrap"
urls = urls[0:17]
json_alerts = get_security_alerts_json(vendor, urls, div_class)
print(json_alerts)
