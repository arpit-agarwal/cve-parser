from common.parser import Parser
from common.json_writer import JSONWriter
from adobe_experience_manager.row_parser import RowParser

def get_publish_date_string(parser):
    table_bulletin_div = parser.get_tag_by_class("table parbase section")
    rows = parser.get_table_body_rows(table_bulletin_div)
    return rows[0].find_all("td")[1].text

def get_title(parser):
    title_soup = parser.get_tag_by_class("page-description").text.strip()
    title_array = title_soup.split("|")
    title_array.reverse()
    title = " ".join(title_array).strip()
    return title

def get_outer_div(parser, security_div_id):
    h2 = parser.get_tag_by_id(security_div_id)
    h2_div = h2.parent.parent
    return h2_div.next_sibling.next_sibling

def get_security_alerts_json(vendor, product, url,security_div_id):
    parser = Parser(url)

    title = get_title(parser)
    outer_div = get_outer_div(parser, security_div_id)
    alerts = parser.get_table_body_rows(outer_div)
    publisging_date = get_publish_date_string(parser)

    row_parser = RowParser(publisging_date)

    writer = JSONWriter(alerts, row_parser)
    json_alerts = writer.get_security_alerts_json(
        "vendor", vendor, url, product, title)
    return json_alerts
