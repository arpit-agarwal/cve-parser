from datetime import datetime
from common.row_parser import BaseRowParser

class RowParser(BaseRowParser):

    def __init__(self, publishing_date):
        super().__init__()
        self.publishing_date = publishing_date
        self.publishing__date_input_format = "%dth of %B %Y"
        self.cve = 0
        self.description = 1
        self.product = 2
        self.version = 3
        self.severity = 4
        self.cvss3_index = 5

    def get_publish_date(self,cells):
        return datetime.strptime(
            self.publishing_date,
            self.publishing__date_input_format)

    def build_product_info(self, title_cell):
        product_node = title_cell.u.next_sibling
        info = product_node.strip()
        # print(info)
        spans = product_node.next_sibling
        # spans = title_cell.find("span")
        # print(title_cell.u.next_sibling.next_sibling)
        # print(spans.string)
        # print(title_cell.strong.text)
        # if spans.string == title_cell.strong.text :
        #     spans = spans.next_sibling
        #     print(spans)
        while spans is not None :
            if spans.string is None:
                for string in spans.stripped_strings:
                    info += string.strip()
                    # print(string.strip())
            else : 
                info += spans.string.strip()
                # print(spans.string.strip())
            spans = spans.next_sibling
            
        info = self.cleanup_product_info(info)
        product_info = info.split(",", 1)

        return product_info

    def cleanup_product_info(self,info):
        info = info.replace("Â", "").replace("â","").replace("\u00a0", "")
        info = info.replace("\u0080\u0093", "")
        start_index = info.index("S")
        return info[start_index:]

    def create_cells_for_update(self, title_cell):
        return None

    def get_cells(self,row):
        # print(row.prettify())
        tds = row.find_all("td")
        cells = list()
        title_cell = tds[1].find("p")

        if title_cell is None: 
            title_cell = tds[1]

        # contents = title_cell.contents
        # print(contents)
        firstword = title_cell.strong.text.split()[0]
        if  firstword != "Update" and firstword != "Multiple" :
            cells.append(title_cell.a)
            cells.append(title_cell.strong)
            
            info = self.build_product_info(title_cell)
            cells += info
            cells.append(tds[2])
            cells.append(tds[3].a)
        else :
            cells = self.create_cells_for_update(title_cell)
        # i=0
        # if cells is not None:
        #     for cell in cells:
        #         print("{}: {}".format(i,cell))
        #         i += 1
        return cells


    def get_version_string(self, cells):
        return cells[self.version]
    
    def get_product(self, cells, vendor, product):
        return cells[self.product][3:].strip()

    def parse_version(self, version_string):
        versions = list()
        version = version_string.strip().strip("-")
        versions.append(version)
        return versions
        
    def cleanup_version_string(self, version_string):
        version = self.cleanup_string(version_string, "Version -")
        version = self.cleanup_string(version, "Versions -")
        return version.strip()


    def cleanup_string(self, string, prefix):
            start_index = string.find(prefix)
            version = string
            if start_index != -1:
                start_index = start_index+len(prefix)
                version = string[start_index:]
            return version

    def normalize_severity(self, severity): 
        if severity == "Hot News":
            return "CRITICAL"
        return severity.upper()

    def get_cvssv3(self, cells):
        a_node  = cells[self.cvss3_index]
        base_score = a_node.text
        vector = a_node.get('href').split('#')[1]
        return {
            "severity": self.normalize_severity(cells[self.severity].text.strip()),
            "base_score": base_score,
            "vector_string": vector
        }

    def get_cpe_list(self, vendor, product, category, cpes):
        tuples = list()
        cpes_list = cpes.split(";")
        for version_string in cpes_list:
            versions = version_string.split(",")
            firstVersion = versions[0]
            firstVersion = self.cleanup_version_string(firstVersion)
            current_product = product
            if not firstVersion[0].isdigit():
                if firstVersion.find(" ") != -1:
                    (product_suffix, firstVersion) = firstVersion.split(" ", 2)
                    current_product +=  product_suffix
                else:
                    firstVersion = firstVersion[1:]

            versions[0] = firstVersion

            tuples.append((vendor, current_product, category, versions))

        return tuples


